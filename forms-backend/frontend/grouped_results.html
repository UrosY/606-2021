<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <title>Grupni odgovori</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    select, button { padding: 5px; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    .back-button { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Grupni odgovori</h1>

  <label for="formSelect">Izaberi formu:</label>
  <select id="formSelect"></select>

  <label for="questionSelect">Izaberi pitanje:</label>
  <select id="questionSelect"></select>

  

  <table id="answersTable">
    <thead>
      <tr>
        <th>Korisnik</th>
        <th>Email</th>
        <th>Odgovor</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="back-button" onclick="window.history.back()">Nazad</button>

  <script>
    const token = localStorage.getItem('token'); // JWT token
    let forms = [];
    let groupedData = null;

    async function loadForms() {
      const res = await fetch('http://localhost:3002/my-forms', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      forms = await res.json();
      const formSelect = document.getElementById('formSelect');
      formSelect.innerHTML = '';
      forms.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.id;
        opt.textContent = f.title;
        formSelect.appendChild(opt);
      });

      if (forms.length > 0) {
        await loadGroupedAnswers(forms[0].id);
      }
    }

    async function loadGroupedAnswers(formId) {
      const res = await fetch(`http://localhost:3002/form/${formId}/grouped-answers`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      groupedData = await res.json();

      const questionSelect = document.getElementById('questionSelect');
      questionSelect.innerHTML = '';
      groupedData.questions.forEach(q => {
        const opt = document.createElement('option');
        opt.value = q.id;
        opt.textContent = q.text;
        questionSelect.appendChild(opt);
      });

      showAnswers();
    }

    async function onFormChange() {
      const formId = document.getElementById('formSelect').value;
      await loadGroupedAnswers(formId);
    }

    function showAnswers() {
      const questionId = document.getElementById('questionSelect').value;
      const tbody = document.getElementById('answersTable').querySelector('tbody');
      tbody.innerHTML = '';

      if (!groupedData) return;
      const question = groupedData.questions.find(q => q.id == questionId);
      if (!question) return;

      question.answers.forEach(a => {
        const answerText = a.selectedOptionTexts ? a.selectedOptionTexts.join(', ') : a.answer_text || '-';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${a.user_name || 'Anoniman'}</td>
          <td>${a.user_email || '-'}</td>
          <td>${answerText}</td>
        `;
        tbody.appendChild(row);
      });
    }

    document.getElementById('formSelect').addEventListener('change', onFormChange);
    document.getElementById('questionSelect').addEventListener('change', showAnswers);

    loadForms();
  </script>
</body>
</html>