<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<title>Izmeni formu</title>
<style>
  body{font-family:sans-serif;}
  .question{border:1px solid #ccc;padding:10px;margin:10px 0;position:relative;}
  .options input{display:block;margin:2px 0;}
  button{margin:2px;}
  .img-preview{max-width:100px; display:block; margin:5px 0;}
</style>
</head>
<body>
<h1>Izmeni formu</h1>

<label>Naziv:</label><input type="text" id="formTitle"><br>
<label>Opis:</label><textarea id="formDesc"></textarea><br><br>

<div id="questions"></div>
<button onclick="addQuestion()">‚ûï Dodaj pitanje</button><br><br>
<button onclick="saveChanges()">üíæ Saƒçuvaj promene</button>

<script>
const token = localStorage.getItem('token');
if (!token) { alert('Morate biti prijavljeni!'); window.location.href = 'index.html'; }

function getParam(name){ return new URLSearchParams(location.search).get(name); }
const formId = getParam('id');

async function loadForm() {
  try {
    const res = await fetch(`http://localhost:3002/form/${formId}`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    if (!res.ok) return alert('Gre≈°ka pri uƒçitavanju forme: ' + (data.error||JSON.stringify(data)));
    const {form, questions} = data;
    document.getElementById('formTitle').value = form.title;
    document.getElementById('formDesc').value = form.description || '';
    questions.forEach(q => addQuestion(q));
  } catch(err) { console.error(err); alert('Gre≈°ka pri uƒçitavanju forme'); }
}

function addQuestion(existing=null){
  const qDiv=document.createElement('div'); qDiv.className='question';
  const qText = existing ? existing.text : '';
  const qId = existing ? existing.id : null;
  const qType = existing ? existing.type : 'short_text';
  const required = existing ? existing.is_required : false;

  qDiv.dataset.qid = qId;
  qDiv.innerHTML=`
    <input type="text" class="qText" placeholder="Tekst pitanja" value="${qText}"><br>
    <label>Slika: <input type="file" class="qImage" accept="image/*"></label>
    ${existing && existing.image_url ? `<img src="${existing.image_url}" class="img-preview">` : ''}
    <select class="qType" onchange="toggleOptions(this)">
      <option value="short_text">Kratak tekst</option>
      <option value="long_text">Dug tekst</option>
      <option value="single_choice">Jedan izbor</option>
      <option value="multiple_choice">Vi≈°e izbora</option>
      <option value="numeric">Broj</option>
      <option value="date">Datum</option>
      <option value="time">Vreme</option>
    </select>
    <div class="options" style="display:none;"></div>
    <button type="button" onclick="addOption(this)">‚ûï Opcija</button>
    <button type="button" onclick="removeQuestion(this)">‚ùå Ukloni</button>
    <button type="button" onclick="moveUp(this)">‚¨ÜÔ∏è</button>
    <button type="button" onclick="moveDown(this)">‚¨áÔ∏è</button>
    <button type="button" onclick="cloneQuestion(this)">üìÑ Kloniraj</button>
    <label><input type="checkbox" class="qRequired" ${required?'checked':''}> Obavezno</label>
  `;
  const sel=qDiv.querySelector('.qType'); sel.value = qType;
  toggleOptions(sel);
  if(existing && existing.options) existing.options.forEach(opt => addOptionToDiv(qDiv, opt.text, opt.id));
  document.getElementById('questions').appendChild(qDiv);
}

function toggleOptions(select){
  const div = select.parentNode.querySelector('.options');
  div.style.display = (select.value==='single_choice'||select.value==='multiple_choice')?'block':'none';
}

function addOption(btn){ addOptionToDiv(btn.parentNode); }
function addOptionToDiv(div, val='', id=null){
  const optionsDiv = div.querySelector('.options');
  const opt = document.createElement('input'); opt.type='text'; opt.placeholder='Opcija'; opt.value=val;
  if(id) opt.dataset.id = id;
  optionsDiv.appendChild(opt); optionsDiv.appendChild(document.createElement('br'));
}

function removeQuestion(btn){ btn.parentNode.remove(); }
function moveUp(btn){ const div=btn.parentNode; const prev=div.previousElementSibling; if(prev){div.parentNode.insertBefore(div,prev);} }
function moveDown(btn){ const div=btn.parentNode; const next=div.nextElementSibling; if(next){div.parentNode.insertBefore(next,div);} }
function cloneQuestion(btn){
  const div=btn.parentNode;
  addQuestion({
    text: div.querySelector('.qText').value,
    type: div.querySelector('.qType').value,
    required: div.querySelector('.qRequired').checked,
    options: Array.from(div.querySelectorAll('.options input')).map(i=>({text:i.value, id:i.dataset.id?parseInt(i.dataset.id):undefined}))
  });
}

async function saveChanges(){
  try {
    const formData = new FormData();
    const questionsPayload = Array.from(document.querySelectorAll('.question')).map((q,i)=>{
      const qId = q.dataset.qid ? parseInt(q.dataset.qid) : undefined;
      const imgInput = q.querySelector('.qImage');
      if(imgInput && imgInput.files[0]) formData.append('images', imgInput.files[0]);
      return {
        id: qId,
        text: q.querySelector('.qText').value.trim(),
        type: q.querySelector('.qType').value,
        required: q.querySelector('.qRequired').checked,
        options: Array.from(q.querySelectorAll('.options input')).map(opt=>({text:opt.value.trim(), id:opt.dataset.id?parseInt(opt.dataset.id):undefined}))
      };
    });
    formData.append('data', JSON.stringify({
      title: document.getElementById('formTitle').value.trim(),
      description: document.getElementById('formDesc').value.trim(),
      questions: questionsPayload
    }));

    const res = await fetch(`http://localhost:3002/edit-form/${formId}`, {
      method: 'PUT',
      headers: { 'Authorization':'Bearer '+token },
      body: formData
    });

    const data = await res.json();
    if(res.ok){
      alert(data.message || 'Forma uspe≈°no izmenjena!');
      window.location.href = 'forms.html';
    } else alert('Gre≈°ka pri ƒçuvanju: '+(data.error||JSON.stringify(data)));

  } catch(err){
    console.error(err);
    alert('Gre≈°ka pri ƒçuvanju promena');
  }
}

loadForm();
</script>
</body>
</html>