<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<title>Kreiraj formu</title>
<style>
  body{font-family:sans-serif;}
  .question { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; position: relative; }
  .move-btn, .remove-btn, .clone-btn { cursor: pointer; font-weight: bold; margin-left: 5px; }
  .remove-btn { color: red; }
  .options input{display:block;margin:2px 0;}
  button{margin:2px;}
</style>
</head>
<body>

<h1>Kreiraj novu formu</h1>

<label>Naziv forme:</label>
<input type="text" id="formTitle"><br><br>

<label>Opis:</label>
<textarea id="formDesc"></textarea><br><br>

<label><input type="checkbox" id="allowGuests"> Dozvoli popunjavanje neprijavljenima</label><br><br>

<h2>Pitanja</h2>
<div id="questions"></div>
<button onclick="addQuestion()">‚ûï Dodaj pitanje</button><br><br>
<button onclick="saveForm()">üíæ Saƒçuvaj formu</button><br><br>

<script>
let questionCount = 0;
const qContainer = document.getElementById('questions');

function addQuestion(data={}) {
  questionCount++;
  const qDiv = document.createElement('div');
  qDiv.className = "question";

  const text = data.text || '';
  const type = data.type || 'short_text';
  const required = data.required || false;
  const options = data.options || [];

  qDiv.innerHTML = `
    <div>
      <span class="move-btn" onclick="moveUp(this)">‚¨ÜÔ∏è</span>
      <span class="move-btn" onclick="moveDown(this)">‚¨áÔ∏è</span>
      <span class="clone-btn" onclick="cloneQuestion(this)">üìÑ Kloniraj</span>
      <span class="remove-btn" onclick="removeQuestion(this)">‚ùå Ukloni</span>
      <strong>Pitanje ${questionCount}</strong>
    </div>
    <input type="text" placeholder="Tekst pitanja" class="qText" value="${text}"><br>
    <label>Tip:</label>
    <select class="qType" onchange="toggleOptions(this)">
      <option value="short_text" ${type==='short_text'?'selected':''}>Kratak tekst</option>
      <option value="long_text" ${type==='long_text'?'selected':''}>Dug tekst</option>
      <option value="single_choice" ${type==='single_choice'?'selected':''}>Jedan izbor</option>
      <option value="multiple_choice" ${type==='multiple_choice'?'selected':''}>Vi≈°e izbora</option>
    </select>
    <div class="options" style="display:${type==='single_choice'||type==='multiple_choice'?'block':'none'};"></div>
    <button type="button" onclick="addOption(this)">‚ûï Dodaj opciju</button><br>
    <label>Dodaj sliku: <input type="file" class="qImage" accept="image/*"></label><br>
    <label><input type="checkbox" class="qRequired" ${required?'checked':''}> Obavezno</label>
  `;
  qContainer.appendChild(qDiv);

  
  const optionsDiv = qDiv.querySelector('.options');
  options.forEach(optText => {
    const opt = document.createElement('input');
    opt.type = 'text';
    opt.placeholder = 'Opcija';
    opt.value = optText;
    optionsDiv.appendChild(opt);
    optionsDiv.appendChild(document.createElement('br'));
  });
}

function toggleOptions(select) {
  const optionsDiv = select.parentNode.querySelector('.options');
  if (select.value==='single_choice'||select.value==='multiple_choice') optionsDiv.style.display='block';
  else { optionsDiv.innerHTML=''; optionsDiv.style.display='none'; }
}

function addOption(btn) {
  const optionsDiv = btn.parentNode.querySelector('.options');
  const opt = document.createElement('input');
  opt.type = 'text';
  opt.placeholder = 'Opcija';
  optionsDiv.appendChild(opt);
  optionsDiv.appendChild(document.createElement('br'));
}

function moveUp(btn){ const qDiv=btn.closest('.question'); const prev=qDiv.previousElementSibling; if(prev) qContainer.insertBefore(qDiv, prev);}
function moveDown(btn){ const qDiv=btn.closest('.question'); const next=qDiv.nextElementSibling; if(next) qContainer.insertBefore(next, qDiv);}
function removeQuestion(btn){ qContainer.removeChild(btn.closest('.question'));}
function cloneQuestion(btn){
  const qDiv=btn.closest('.question');
  const text=qDiv.querySelector('.qText').value;
  const type=qDiv.querySelector('.qType').value;
  const required=qDiv.querySelector('.qRequired').checked;
  const options=Array.from(qDiv.querySelectorAll('.options input')).map(opt=>opt.value);
  addQuestion({text,type,required,options});
}

async function saveForm() {
  const token = localStorage.getItem('token');
  const formTitle = document.getElementById('formTitle').value.trim();
  const formDesc = document.getElementById('formDesc').value.trim();
  const allowGuests = document.getElementById('allowGuests').checked;

  const questions = [];
  const images = [];

  qContainer.querySelectorAll('.question').forEach(q=>{
    const text=q.querySelector('.qText').value.trim();
    const type=q.querySelector('.qType').value;
    const required=q.querySelector('.qRequired').checked;
    const options=Array.from(q.querySelectorAll('.options input')).map(opt=>opt.value).filter(v=>v!=='');
    const imageInput = q.querySelector('.qImage');
    questions.push({text,type,required,options});
    images.push(imageInput.files[0] || null);
  });

  const formData = new FormData();
  formData.append('data', JSON.stringify({ title: formTitle, description: formDesc, allowGuests, questions }));
  images.forEach(img => { if(img) formData.append('images', img); });

  const res = await fetch('http://localhost:3002/create-form', {
    method:'POST',
    headers:{ 'Authorization':'Bearer '+token },
    body: formData
  });
  const data = await res.json();
  if(data.success){ alert('Forma je uspe≈°no kreirana!'); window.location.href='forms.html'; }
  else alert('Gre≈°ka: '+(data.message||JSON.stringify(data)));
}
</script>

</body>
</html>